<!doctype html>
<html>
  <body>
    <div id="root">
      <header>
        <h1>Weeks of Life</h1>
        <div>
          <label for="year-input">Year</label>
          <input type="number" id="year-input" />
          <label for="day-select">Day</label>
          <select id="day-select"></select>
          <label for="month-select">Month</label>
          <select id="month-select"></select>
        </div>
      </header>
      <main>
        <table>
          <tbody></tbody>
        </table>
      </main>
    </div>
    <script>
      const yearInput = document.querySelector("#year-input");
      const monthSelect = document.querySelector("#month-select");
      const daySelect = document.querySelector("#day-select");

      const dayOptions = [];
      for (let i = 1; i <= 31; ++i) {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = i;
        dayOptions.push(option);
        daySelect.add(option);
      }

      const monthOptions = [];
      for (let i = 1; i <= 12; ++i) {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = i;
        monthOptions.push(option);
        monthSelect.add(option);
      }

      function monthToDays(month) {
        switch (month) {
          case 2:
            return 28;
          case 11:
          case 4:
          case 6:
          case 9:
            return 30;
          default:
            return 31;
        }
      }

      function limitMonthOptions(upToMonth) {
        if (monthSelect.length === upToMonth) return;
        for (let i = 0; i < monthOptions.length; ++i) {
          if (i < upToMonth && !monthSelect.item(i)) {
            monthSelect.add(monthOptions[i]);
            continue;
          }
          if (i >= upToMonth) monthOptions[i].remove();
        }
      }

      function limitDayOptions(upToDay) {
        if (daySelect.length === upToDay) return;
        for (let i = 0; i < dayOptions.length; ++i) {
          if (i < upToDay && !daySelect.item(i)) {
            daySelect.add(dayOptions[i]);
            continue;
          }
          if (i >= upToDay) dayOptions[i].remove();
        }
      }

      monthSelect.addEventListener("change", function () {
        const month = parseInt(monthSelect.value);
        if (Number.isNaN(month)) return;
        limitDayOptions(monthToDays(month));
      });

      const checkboxes = [];
      const tbody = document.querySelector("tbody");
      const [maxYears, maxWeeksPerYear] = [100, 52];
      for (let i = 0; i < maxYears; ++i) {
        const tr = document.createElement("tr");
        for (let j = 0; j < maxWeeksPerYear; ++j) {
          const td = document.createElement("td");
          const checkbox = document.createElement("input");
          checkboxes.push(checkbox);
          checkbox.type = "checkbox";
          td.appendChild(checkbox);
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      function getNowDate() {
        const _nowDate = new Date();
        return {
          year: _nowDate.getUTCFullYear(),
          month: _nowDate.getUTCMonth() + 1, // month is zero-indexed (what????)
          day: _nowDate.getUTCDate(),
        };
      }

      function getBirthDate() {
        const birth = {
          year: parseInt(yearInput.value),
          month: parseInt(monthSelect.value),
          day: parseInt(daySelect.value),
        };
        if (
          Number.isNaN(birth.year) ||
          Number.isNaN(birth.month) ||
          Number.isNaN(birth.day)
        ) {
          return null;
        }
        return birth;
      }

      function checkBirthDate() {
        if (!(yearInput.value && daySelect.value && monthSelect.value)) return;
        const now = getNowDate();
        const birth = getBirthDate();
        if (Object.is(birth, null)) {
          console.error("birth date is invalid");
          return;
        }
        // region constrain date selection if date is current
        if (birth.year == now.year) {
          if (birth.month > now.month) monthSelect.value = now.month;
          if (birth.month === now.month) {
            limitMonthOptions(now.month);
            limitDayOptions(now.day);
          }
        } else {
          limitMonthOptions(12);
          limitDayOptions(monthToDays(birth.month));
        }
        // endregion
        let days = monthToDays(birth.month) - birth.day; // offset to closest month (ceil)
        for (let i = birth.month + 1; i <= 12; ++i) days += monthToDays(i); // add days up to next year
        days += (now.year - birth.year - 1) * 365; // add whole years
        for (let i = 1; i <= now.month; ++i) days += monthToDays(i); // add current time's months
        days += now.day; // add current time's days
        const weeks = Math.floor(days / 7);
        for (let i = 0; i < checkboxes.length; ++i) {
          if (i < weeks) {
            checkboxes[i].setAttribute("checked", "");
          } else {
            checkboxes[i].removeAttribute("checked");
          }
        }
      }

      yearInput.addEventListener("change", checkBirthDate);
      monthSelect.addEventListener("change", checkBirthDate);
      daySelect.addEventListener("change", checkBirthDate);

      addEventListener("load", function () {
        const now = getNowDate();
        yearInput.max = now.year;
        yearInput.min = now.year - 100;
        yearInput.value = now.year;
        monthSelect.value = now.month;
        daySelect.value = now.day;
        checkBirthDate();
      });
    </script>
  </body>
</html>
