<!doctype html>
<html>
  <body>
    <div id="root">
      <header>
        <h1>Weeks of Life</h1>
        <div>
          <label for="year-input">Year</label>
          <input type="number" id="year-input" />
          <label for="day-select">Day</label>
          <select id="day-select"></select>
          <label for="month-select">Month</label>
          <select id="month-select">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
          </select>
        </div>
      </header>
      <main>
        <table>
          <tbody></tbody>
        </table>
      </main>
    </div>
    <script>
      const yearInput = document.querySelector("#year-input");
      const monthSelect = document.querySelector("#month-select");
      const daySelect = document.querySelector("#day-select");
      {
        const now = new Date().getFullYear();
        yearInput.max = now;
        yearInput.min = now - 100;
      }

      const dayOptions = [];
      for (let i = 1; i <= 31; ++i) {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = i;
        dayOptions.push(option);
        daySelect.add(option);
      }

      function monthToDays(month) {
        switch (month) {
          case 2:
            return 28;
          case 11:
          case 4:
          case 6:
          case 9:
            return 30;
          default:
            return 31;
        }
      }

      function updateDaySelectOptions(event) {
        const month = parseInt(event.target.value);
        if (monthToDays(month) === 2) {
          if (daySelect.childElementCount === 28) return;
          try {
            dayOptions[28].remove();
            dayOptions[29].remove();
            dayOptions[30].remove();
          } catch {}
          return;
        }
        if (monthToDays(month) === 30) {
          if (daySelect.childElementCount === 30) return;
          try {
            dayOptions[30].remove();
          } catch {}
          if (!daySelect.children.includes(dayOptions[28])) {
            daySelect.add(dayOptions[28]);
          }
          if (!daySelect.children.includes(dayOptions[29])) {
            daySelect.add(dayOptions[29]);
          }
          return;
        }
        if (daySelect.childElementCount === 31) return;
        if (!daySelect.children.item(28)) {
          daySelect.add(dayOptions[28]);
        }
        if (!daySelect.children.item(29)) {
          daySelect.add(dayOptions[29]);
        }
        if (!daySelect.children.item(30)) {
          daySelect.add(dayOptions[30]);
        }
      }

      monthSelect.addEventListener("change", updateDaySelectOptions);

      const checkboxes = [];
      const tbody = document.querySelector("tbody");
      const [maxYears, maxWeeksPerYear] = [100, 52];
      for (let i = 0; i < maxYears; ++i) {
        const tr = document.createElement("tr");
        for (let j = 0; j < maxWeeksPerYear; ++j) {
          const td = document.createElement("td");
          const checkbox = document.createElement("input");
          checkboxes.push(checkbox);
          checkbox.type = "checkbox";
          td.appendChild(checkbox);
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }

      function checkBirthDate(event) {
        if (!(yearInput.value && daySelect.value && monthSelect.value)) return;
        const birth = {
          year: parseInt(yearInput.value),
          month: parseInt(monthSelect.value),
          day: parseInt(daySelect.value),
        };
        const now = {};
        {
          const _nowDate = new Date();
          now.year = _nowDate.getUTCFullYear();
          now.month = _nowDate.getUTCMonth() + 1; // month is zero-indexed (what????)
          now.day = _nowDate.getUTCDate();
        }
        let days = monthToDays(birth.month) - birth.day; // offset to closest month (ceil)
        for (let i = birth.month + 1; i <= 12; ++i) days += monthToDays(i); // add days up to next year
        days += (now.year - birth.year - 1) * 365; // add whole years
        for (let i = 1; i <= now.month; ++i) days += monthToDays(i); // add current time's months
        days += now.day; // add current time's days
        const weeks = Math.floor(days / 7);
        for (let i = 1; i <= checkboxes.length; ++i) {
          if (i <= weeks) {
            checkboxes[i].setAttribute("checked", "");
          } else {
            checkboxes[i].removeAttribute("checked");
          }
        }
      }

      yearInput.addEventListener("change", checkBirthDate);
      monthSelect.addEventListener("change", checkBirthDate);
      daySelect.addEventListener("change", checkBirthDate);
    </script>
  </body>
</html>
